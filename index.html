<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Christmas Card Label Printer</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Georgia", serif;
        background: url("https://images.unsplash.com/photo-1708961462805-9949475ea462?q=80&w=1470&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D")
          center/cover no-repeat;
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: linear-gradient(135deg, #c41e3a 0%, #2e8b57 100%);
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 10px;
        font-size: 2.5em;
      }

      .subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 30px;
        font-style: italic;
      }

      .controls {
        text-align: center;
        margin-bottom: 30px;
      }

      button {
        background: #c41e3a;
        color: white;
        border: none;
        padding: 15px 40px;
        font-size: 1.1em;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: bold;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .screen-only {
        display: block;
      }

      .preview {
        border: 2px dashed #ccc;
        padding: 20px;
        background: #f9f9f9;
        border-radius: 8px;
      }

      .preview h2 {
        color: #c41e3a;
        margin-bottom: 20px;
      }

      /* Print styles */
      @media print {
        body {
          background: white;
          padding: 0;
          margin: 0;
        }

        .screen-only {
          display: none !important;
        }

        .container {
          max-width: none;
          padding: 0;
          box-shadow: none;
          border-radius: 0;
        }

        .print-area {
          display: block !important;
        }
      }

      /* A4 Print Layout */
      @page {
        size: A4 portrait;
        margin: 15mm;
      }

      .print-area {
        display: none;
      }

      @media print {
        .print-area {
          width: 210mm;
          display: flex;
          flex-direction: column;
          gap: 8mm;
          padding: 0;
        }

        .label-row {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 8mm;
        }
      }

      .label {
        border: 1px solid #ddd;
        padding: 12px;
        background: white;
        page-break-inside: avoid;
        min-height: 35mm;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      @media print {
        .label {
          border: 1px dashed #999;
          font-size: 11pt;
          line-height: 1.4;
        }

        .label-actions {
          display: none !important;
        }
      }

      .label-name {
        font-weight: bold;
        margin-bottom: 4px;
        font-size: 1.1em;
      }

      .label-address {
        color: #333;
      }

      /* Preview grid on screen */
      .preview .print-area {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .preview .label-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="screen-only">
        <h1 id="main-title">Christmas Card Labels</h1>

        <div id="initial-selection" class="controls">
          <button onclick="showRecipientLabels()">
            üéÑ Christmas Recipient Labels
          </button>
          <button onclick="showSenderLabels()">
            üìÆ Christmas Sender Labels
          </button>
        </div>

        <div id="label-controls" class="controls" style="display: none">
          <button onclick="goBack()" class="back-btn">‚Üê Back</button>
          <p class="subtitle" id="subtitle"></p>
          <button onclick="printRecipientLabels()">
            üñ®Ô∏è Print Recipient Labels
          </button>
          <button onclick="toggleAddForm()" style="background: #28a745">
            ‚ûï Add Recipient
          </button>
        </div>

        <div id="sender-controls" class="controls" style="display: none">
          <button onclick="goBack()" class="back-btn">‚Üê Back</button>
          <p class="subtitle">
            Create and print sender labels for your Christmas cards
          </p>
          <button onclick="printSenderLabels()">üñ®Ô∏è Print Sender Labels</button>
          <button onclick="toggleSenderForm()" style="background: #28a745">
            ‚ûï Set Sender Info
          </button>
        </div>

        <div class="preview" id="preview-section" style="display: none">
          <h2>Preview (Total: <span id="count">0</span> addresses)</h2>
          <div id="preview-area"></div>
        </div>

        <div
          id="add-recipient-form"
          style="
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
          "
        >
          <h3>Add New Recipient</h3>
          <form id="recipient-form">
            <input
              type="text"
              id="name"
              placeholder="Name"
              required
              style="
                width: 100%;
                margin: 5px 0;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
              "
            />
            <input
              type="text"
              id="address"
              placeholder="Address"
              required
              style="
                width: 100%;
                margin: 5px 0;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
              "
            />
            <input
              type="text"
              id="city"
              placeholder="City"
              required
              style="
                width: 100%;
                margin: 5px 0;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
              "
            />
            <input
              type="text"
              id="state"
              placeholder="State"
              required
              style="
                width: 100%;
                margin: 5px 0;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
              "
            />
            <input
              type="text"
              id="zip"
              placeholder="ZIP Code"
              required
              style="
                width: 100%;
                margin: 5px 0;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
              "
            />
            <button type="submit" style="margin: 10px 5px 0 0">
              Add Recipient
            </button>
            <button
              type="button"
              onclick="toggleAddForm()"
              style="background: #6c757d"
            >
              Cancel
            </button>
          </form>
        </div>

        <div
          id="add-sender-form"
          style="
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
          "
        >
          <h3>Set Sender Information</h3>
          <form id="sender-form">
            <input
              type="text"
              id="sender-name"
              placeholder="Sender Name"
              required
              style="
                width: 100%;
                margin: 5px 0;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
              "
            />
            <input
              type="text"
              id="sender-address"
              placeholder="Sender Address"
              required
              style="
                width: 100%;
                margin: 5px 0;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
              "
            />
            <input
              type="text"
              id="sender-city"
              placeholder="Sender City"
              required
              style="
                width: 100%;
                margin: 5px 0;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
              "
            />
            <input
              type="text"
              id="sender-state"
              placeholder="Sender State"
              required
              style="
                width: 100%;
                margin: 5px 0;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
              "
            />
            <input
              type="text"
              id="sender-zip"
              placeholder="Sender ZIP Code"
              required
              style="
                width: 100%;
                margin: 5px 0;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
              "
            />
            <input
              type="number"
              id="label-count"
              placeholder="Type the number of labels to print"
              min="1"
              required
              style="
                width: 100%;
                margin: 5px 0;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
              "
            />
            <button type="submit" style="margin: 10px 5px 0 0">
              Set Sender
            </button>
            <button
              type="button"
              onclick="toggleSenderForm()"
              style="background: #6c757d"
            >
              Cancel
            </button>
          </form>
        </div>

        <div class="preview" id="sender-preview-section" style="display: none">
          <h2>
            Sender Preview (Total: <span id="sender-count">0</span> labels)
          </h2>
          <div id="sender-preview-area"></div>
        </div>
      </div>

      <div class="print-area" id="print-area"></div>
    </div>

    <script>
      let addresses = [];
      let senders = [];

      async function loadAddresses() {
        try {
          const response = await fetch("/api/recipients");
          addresses = await response.json();
          renderLabels();
        } catch (error) {
          console.error("Error loading addresses:", error);
          document.getElementById("count").textContent =
            "Error loading addresses";
        }
      }

      async function loadSenders() {
        try {
          const response = await fetch("/api/senders");
          senders = await response.json();
          renderSenderLabels();
        } catch (error) {
          console.error("Error loading senders:", error);
        }
      }

      async function addRecipient(recipientData) {
        try {
          const response = await fetch("/api/recipients", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(recipientData),
          });
          const newRecipient = await response.json();
          addresses.push(newRecipient);
          renderLabels();
          return newRecipient;
        } catch (error) {
          console.error("Error adding recipient:", error);
        }
      }

      async function deleteRecipient(id) {
        if (!confirm("Are you sure you want to delete this recipient?")) return;
        try {
          await fetch(`/api/recipients/${id}`, { method: "DELETE" });
          addresses = addresses.filter((addr) => addr.id !== id);
          renderLabels();
        } catch (error) {
          console.error("Error deleting recipient:", error);
        }
      }

      async function editRecipient(id) {
        const recipient = addresses.find((addr) => addr.id === id);
        if (!recipient) return;

        document.getElementById("name").value = recipient.name;
        document.getElementById("address").value = recipient.address;
        document.getElementById("city").value = recipient.city;
        document.getElementById("state").value = recipient.state;
        document.getElementById("zip").value = recipient.zip;

        const form = document.getElementById("recipient-form");
        form.dataset.editId = id;
        toggleAddForm();
      }

      function toggleAddForm() {
        const form = document.getElementById("add-recipient-form");
        const isVisible = form.style.display !== "none";
        form.style.display = isVisible ? "none" : "block";

        if (!isVisible) {
          document.getElementById("recipient-form").reset();
          delete document.getElementById("recipient-form").dataset.editId;
        }
      }

      document
        .getElementById("recipient-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = {
            name: document.getElementById("name").value,
            address: document.getElementById("address").value,
            city: document.getElementById("city").value,
            state: document.getElementById("state").value,
            zip: document.getElementById("zip").value,
          };

          const editId = e.target.dataset.editId;

          if (editId) {
            try {
              const response = await fetch(`/api/recipients/${editId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(formData),
              });
              const updatedRecipient = await response.json();
              const index = addresses.findIndex((addr) => addr.id == editId);
              addresses[index] = updatedRecipient;
              renderLabels();
            } catch (error) {
              console.error("Error updating recipient:", error);
            }
          } else {
            await addRecipient(formData);
          }

          toggleAddForm();
        });

      function createLabel(addr) {
        const label = document.createElement("div");
        label.className = "label";
        label.innerHTML = `
          <div class="label-name">${addr.name}</div>
          <div class="label-address">
            ${addr.address}<br>
            ${addr.city}, ${addr.state} ${addr.zip}
          </div>
          <div class="label-actions" style="margin-top: 8px; display: flex; gap: 5px;">
            <button onclick="editRecipient(${addr.id})" style="padding: 4px 8px; font-size: 0.8em; background: #ffc107; color: #000;">Edit</button>
            <button onclick="deleteRecipient(${addr.id})" style="padding: 4px 8px; font-size: 0.8em; background: #dc3545;">Delete</button>
          </div>
        `;
        return label;
      }

      function goBack() {
        const initialSelection = document.getElementById("initial-selection");
        const labelControls = document.getElementById("label-controls");
        const senderControls = document.getElementById("sender-controls");
        const previewSection = document.getElementById("preview-section");
        const senderPreviewSection = document.getElementById(
          "sender-preview-section"
        );
        const addForm = document.getElementById("add-recipient-form");
        const senderForm = document.getElementById("add-sender-form");

        initialSelection.style.display = "block";
        labelControls.style.display = "none";
        senderControls.style.display = "none";
        previewSection.style.display = "none";
        senderPreviewSection.style.display = "none";
        addForm.style.display = "none";
        senderForm.style.display = "none";
      }

      function showRecipientLabels() {
        const initialSelection = document.getElementById("initial-selection");
        const labelControls = document.getElementById("label-controls");
        const previewSection = document.getElementById("preview-section");
        const subtitle = document.getElementById("subtitle");

        subtitle.textContent =
          "Manage and print recipient labels for your Christmas cards";
        initialSelection.style.display = "none";
        labelControls.style.display = "block";
        previewSection.style.display = "block";
      }

      function showSenderLabels() {
        const initialSelection = document.getElementById("initial-selection");
        const senderControls = document.getElementById("sender-controls");
        const senderPreviewSection = document.getElementById(
          "sender-preview-section"
        );

        initialSelection.style.display = "none";
        senderControls.style.display = "block";
        senderPreviewSection.style.display = "block";
        loadSenders();
      }

      function toggleSenderForm() {
        const form = document.getElementById("add-sender-form");
        const isVisible = form.style.display !== "none";
        form.style.display = isVisible ? "none" : "block";

        if (!isVisible) {
          document.getElementById("sender-form").reset();
          delete document.getElementById("sender-form").dataset.editId;
        }
      }

      function renderSenderLabels() {
        const previewArea = document.getElementById("sender-preview-area");
        const countSpan = document.getElementById("sender-count");

        previewArea.innerHTML = "";

        if (senders.length === 0) {
          previewArea.innerHTML =
            "<p>No saved senders. Add one to get started.</p>";
          countSpan.textContent = "0";
          return;
        }

        // Show all saved senders
        senders.forEach((sender) => {
          const senderDiv = document.createElement("div");
          senderDiv.style.cssText =
            "border: 1px solid #ddd; padding: 15px; margin: 10px 0; background: white; border-radius: 8px;";
          senderDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong>${sender.name}</strong><br>
                ${sender.address}<br>
                ${sender.city}, ${sender.state} ${sender.zip}<br>
                <em>Labels: ${sender.label_count}</em>
              </div>
              <div>
                <button onclick="editSender(${sender.id})" style="padding: 8px 12px; margin: 0 5px; background: #ffc107; color: #000; border: none; border-radius: 4px; cursor: pointer;">Edit</button>
                <button onclick="deleteSender(${sender.id})" style="padding: 8px 12px; margin: 0 5px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Delete</button>
                <button onclick="printThisSender(${sender.id})" style="padding: 8px 12px; margin: 0 5px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Print</button>
              </div>
            </div>
          `;
          previewArea.appendChild(senderDiv);
        });

        countSpan.textContent = senders.length;
      }

      document
        .getElementById("sender-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const senderData = {
            name: document.getElementById("sender-name").value,
            address: document.getElementById("sender-address").value,
            city: document.getElementById("sender-city").value,
            state: document.getElementById("sender-state").value,
            zip: document.getElementById("sender-zip").value,
            label_count:
              parseInt(document.getElementById("label-count").value) || 20,
          };

          const editId = e.target.dataset.editId;

          if (editId) {
            try {
              const response = await fetch(`/api/senders/${editId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(senderData),
              });
              const updatedSender = await response.json();
              const index = senders.findIndex((sender) => sender.id == editId);
              senders[index] = updatedSender;
              renderSenderLabels();
            } catch (error) {
              console.error("Error updating sender:", error);
            }
          } else {
            try {
              const response = await fetch("/api/senders", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(senderData),
              });
              const newSender = await response.json();
              senders.unshift(newSender);
              renderSenderLabels();
            } catch (error) {
              console.error("Error adding sender:", error);
            }
          }

          toggleSenderForm();
        });

      async function deleteSender(id) {
        if (!confirm("Are you sure you want to delete this sender?")) return;
        try {
          await fetch(`/api/senders/${id}`, { method: "DELETE" });
          senders = senders.filter((sender) => sender.id !== id);
          renderSenderLabels();
        } catch (error) {
          console.error("Error deleting sender:", error);
        }
      }

      async function editSender(id) {
        const sender = senders.find((s) => s.id === id);
        if (!sender) return;

        document.getElementById("sender-name").value = sender.name;
        document.getElementById("sender-address").value = sender.address;
        document.getElementById("sender-city").value = sender.city;
        document.getElementById("sender-state").value = sender.state;
        document.getElementById("sender-zip").value = sender.zip;
        document.getElementById("label-count").value = sender.label_count;

        const form = document.getElementById("sender-form");
        form.dataset.editId = id;
        toggleSenderForm();
      }

      function printThisSender(id) {
        const sender = senders.find((s) => s.id === id);
        if (!sender) return;

        const printArea = document.getElementById("print-area");
        printArea.innerHTML = "";

        const senderLabels = Array(sender.label_count).fill(sender);

        for (let i = 0; i < senderLabels.length; i += 2) {
          const row = document.createElement("div");
          row.className = "label-row";

          row.appendChild(createLabel(senderLabels[i]));

          if (i + 1 < senderLabels.length) {
            row.appendChild(createLabel(senderLabels[i + 1]));
          }

          printArea.appendChild(row);
        }

        window.print();
      }

      function selectHoliday(holiday) {
        // Function removed - no longer needed
      }

      function printRecipientLabels() {
        renderLabels(addresses);
        window.print();
      }

      function printSenderLabels() {
        // Print current sender labels
        window.print();
      }

      function renderLabels(addressList = addresses) {
        const printArea = document.getElementById("print-area");
        const previewArea = document.getElementById("preview-area");
        const countSpan = document.getElementById("count");

        printArea.innerHTML = "";
        previewArea.innerHTML = "";

        for (let i = 0; i < addressList.length; i += 2) {
          const row = document.createElement("div");
          row.className = "label-row";

          row.appendChild(createLabel(addressList[i]));

          if (i + 1 < addressList.length) {
            row.appendChild(createLabel(addressList[i + 1]));
          }

          printArea.appendChild(row.cloneNode(true));
          previewArea.appendChild(row);
        }

        countSpan.textContent = addressList.length;
      }

      loadAddresses();
    </script>
  </body>
</html>
